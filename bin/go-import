#!/usr/bin/env ruby

require "thor"
require "go_import"

RUNNER_DIR = ".go_import"

class GoImportCommandLine < Thor

    desc "about", "About go-import"
    def about()
        puts "go-import is an import tool for LIME Go. It can take virtually any input source and create import data files that LIME Go likes. go-import has some predefined sources that will make it easy for you to migrate your data."
        puts ""
    end

    desc "list-sources", "Lists the available sources"
    def list_sources()
        puts "The following sources are available:"
        puts

        sources = GoImport::Sources.new(source_path)
        sources.list().each do |s|
            puts "\t#{s}"
        end

        puts "\nCreate a new project with 'go-import new' with one of these sources."
    end

    desc "new <PROJECT> <SOURCE>", "Creates a new migration project with a specifed name and source"
    def new(project, source)
        sources = GoImport::Sources.new(source_path)

        if sources.create_project_from_source(project, source)
            puts "\nProject '#{project}' created from source '#{source}'."
            puts "Modify the #{project}/converter.rb script to suit your source."
            puts "Use 'go-import run' from the project directory to create the zip file for LIME Go."
        end
    end

    desc "run", "Executes the current project and create a go.zip file with data and files. Existing go.zip will be overwritten, use --output to specify a different filename."
    option(:output,
           :desc => "Name of the file where the converted source will be saved. This file should be sent to LIME Go. If the file already exist it will be replaced.",
           :type => :string,
           :required => false)
    option(:ignore_missing_files,
           :desc => "Output will be created even if the import contains missing files",
           :type => :boolean,
           :required => false)
    option(:log_to_file,
           :desc => "Console output will be redirected to file",
           :type => :string,
           :required => false)
    def run_import()
        if !options.log_to_file.nil?
            $stdout = File.new(options.log_to_file == "log_to_file" ? "go-import.log" : options.log_to_file, 'w')
            $stdout.sync = true
        end

        if !is_valid_goimport_project?
            return
        end

        runner_file = File.expand_path("./#{RUNNER_DIR}/runner.rb", Dir.pwd)
        require(runner_file)
        model = convert_source()

        if model.documents.files.length > 0 && (!defined?(FILES_FOLDER) || FILES_FOLDER.empty?())
            puts "WARNING: It looks like you are importing files but FILES_FOLDER has not been set in your converter.rb."
            puts "WARNING: FILES_FOLDER should be set unless you are only importing files with absolute paths."
        end

        if model.documents.files.length > 0 && (!defined?(FILES_FOLDER_AT_CUSTOMER) || FILES_FOLDER_AT_CUSTOMER.empty?())
            puts "WARNING: It looks like you are importing files but FILES_FOLDER_AT_CUSTOMER has not been set in your converter.rb"
            puts "WARNING: This means that files with an absolute path will be imported with their original path. Set this constant if you want to get files from the FILES_FOLDER directory."
        end

        is_ok, error_msg = can_be_serialized?(model, options.ignore_missing_files)
        if is_ok
            if options.ignore_missing_files && model.documents.files.length > 0
                log_and_remove_missing_files model
            end

            go_data_zip = options.output.nil? == true ? "go.zip" : options.output
            model.save_to_zip(go_data_zip)
            puts "Source has been been converted into '#{go_data_zip}'."
        else
            puts "ERROR: Source could not be converted due to:"
            puts error_msg

            if !options.ignore_missing_files &&
                    model.documents.files.any? {|file| !::File.exists?(file.path_for_project)}
                puts "go-import detected missing files (see above), you can ignore these with the option --ignore-missing-files."
            end
        end
    end

    private
    def log_and_remove_missing_files(model)
        if model.documents.files.length > 0
            puts "Trying to log files that can't be found..."
            file_log_header = "name;integration_id;path;organization.integrationid;organization.name;deal.integrationid;deal.name"
            file_log = ""
            files_to_remove = []
            model.documents.files.each do |file|
                if !::File.exists?(file.path_for_project)
                    file_log = "#{file_log}#{file.name};#{file.integration_id};#{file.path};#{file.organization.nil? ? '' : file.organization.integration_id};#{file.organization.nil? ? '' : file.organization.name};#{file.deal.nil? ? '' : file.deal.integration_id};#{file.deal.nil? ? '' : file.deal.name}\n"
                    files_to_remove.push file
                end
            end

            files_to_remove.each do |file|
                model.documents.files.delete file
            end

            if file_log.length > 0
                log_filename = 'go-import-missing-files.csv'
                ::File.open(log_filename, 'w') { |f|
                    f.puts file_log_header
                    f.puts file_log
                }
                puts "WARNING: go-import has ignored files. Filenames of all ignored files has been written to '#{log_filename}'."
            else
                puts "All files are OK."
            end
        end
    end

    private
    def can_be_serialized?(rootmodel, ignore_missing_files)
        is_ok = false
        error = rootmodel.sanity_check
        if error.empty?
            error = rootmodel.validate(ignore_missing_files)

            if error.empty?
                is_ok = true
            end
        end

        return [is_ok, error]
    end

    private
    def is_valid_goimport_project?()
        if Dir.exists?(RUNNER_DIR) == false
            puts "This doesnt look like a go-import project. Are you in the right directory or did you mess with the '#{RUNNER_DIR}' folder?"
            return false
        end

        runner_file = File.expand_path("./#{RUNNER_DIR}/runner.rb", Dir.pwd)
        if File.exists?(runner_file) == false
            puts "I can't run this project. Did you mess with the '#{RUNNER_DIR}' folder?"
            return false
        end

        return true
    end

    private
    def source_path()
        File.expand_path("../sources", File.dirname(__FILE__))
    end
end

GoImportCommandLine.start(ARGV)

